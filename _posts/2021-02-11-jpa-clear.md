---
title: "JPA Clear"
search: false
category:
  - spring-boot
  - jpa
  - junit
last_modified_at: 2021-08-22T02:30:00
---

<br>

âš ï¸ í•´ë‹¹ í¬ìŠ¤íŠ¸ëŠ” 2021ë…„ 8ì›” 22ì¼ì— ì¬ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¶ˆí•„ìš” ì½”ë“œ ì œê±°)

ğŸ‘‰ í•´ë‹¹ í¬ìŠ¤íŠ¸ë¥¼ ì½ëŠ”ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.
- [JPA(Java Persistence API)][jpa-blog-link]
- [JPA Persistence Context][jpa-persistence-context-link]
- [ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(Persistence Context) ì¥ì ][persistence-context-advantages-link]
- [JPA Flush][jpa-flush-link]

## 0. ë“¤ì–´ê°€ë©´ì„œ

[JPA Flush][jpa-flush-link] í¬ìŠ¤íŠ¸ì˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‘ì„± ì‹œ ë§ˆì£¼ì¹œ í˜„ìƒê³¼ ì´ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤. 
ì§€ë‚œ ê¸€ì„ í¬ìŠ¤íŒ…í•˜ëŠ” ë‹¹ì‹œì— ì˜ëª» ì´í•´í•œ ë¶€ë¶„ì´ ìˆì—ˆê³ , í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì—ì„œ ì›ì¹˜ì•ŠëŠ” ê²°ê³¼ë¥¼ ì–»ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. 

> **ì˜ëª» ì´í•´í•œ ë‚´ìš© - JPQLì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜í•´ ê´€ë¦¬ë˜ê³  ìˆëŠ” ë°ì´í„°ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šê³  ë™ì‘í•©ë‹ˆë‹¤.** 

JPQLë„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” ë°ì´í„°ë¥¼ ê³ ë ¤í•˜ê³  ë™ì‘í•˜ëŠ” ë¶€ë¶„ì´ ìˆì—ˆìŠµë‹ˆë‹¤. 
JPQLì€ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì˜€ì„ ë•Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë™ì¼ @Idë¡œ ê´€ë¦¬ë˜ëŠ” ì—”í‹°í‹°ê°€ ìˆë‹¤ë©´ ì¡°íšŒí•œ ë°ì´í„°ë¥¼ ë²„ë¦¬ê³  ìºì‹±ëœ ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. 

## 1. ì˜ˆìƒ ì‹œë‚˜ë¦¬ì˜¤
ì˜ˆìƒí•œ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
1. FlushModeType.AUTO ì˜µì…˜ ì‚¬ìš©
1. @Idë¡œ ì¡°íšŒí•œ ì—”í‹°í‹°ì˜ í•„ë“œ ê°’ì„ ë³€í™˜ (flushë¥¼ í†µí•œ ì—…ë°ì´íŠ¸ ì˜ˆìƒ)
1. JPQLë¡œ ë™ì¼ ROW ì—…ë°ì´íŠ¸ (flush ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì—ì–´ì¹  ê²ƒìœ¼ë¡œ ì˜ˆìƒ)
1. JPQL SELECT ì¿¼ë¦¬ë¥¼ ì´ìš©í•œ ê°ì²´ ì¡°íšŒ
1. **ì´ì „ì— ì¡°íšŒí•œ ì—”í‹°í‹°ì™€ JQPLë¡œ ì¡°íšŒí•œ ê°ì²´ê°€ ì„œë¡œ ë‹¤ë¥¸ ê°ì²´ë¡œ ë‘ ê°ì²´ê°€ ì§€ë‹Œ ê°’ì´ ë‹¤ë¥¼ ê²ƒìœ¼ë¡œ ì˜ˆìƒ (ì˜ëª» ì´í•´í•œ ë¶€ë¶„)**

##### ì˜ˆìƒ ì‹œë‚˜ë¦¬ì˜¤ ì´ë¯¸ì§€
<p align="center"><img src="/images/jpa-clear-1.JPG" width="750"></p>

## 2. ì‹¤ì œ ë™ì‘
ì‹¤ì œë¡œ ë™ì‘í•œ ê²ƒì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
1. FlushModeType.AUTO ì˜µì…˜ ì‚¬ìš©
1. @Idë¡œ ì¡°íšŒí•œ ì—”í‹°í‹°ì˜ í•„ë“œ ê°’ì„ ë³€í™˜ (flushë¥¼ í†µí•œ ì—…ë°ì´íŠ¸ ì˜ˆìƒ)
1. JPQLë¡œ ë™ì¼ ROW ì—…ë°ì´íŠ¸ (flush ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì—ì–´ì¹  ê²ƒìœ¼ë¡œ ì˜ˆìƒ)
1. JPQL SELECT ì¿¼ë¦¬ë¥¼ ì´ìš©í•œ ê°ì²´ ì¡°íšŒ
1. **ì´ì „ì— ì¡°íšŒí•œ ì—”í‹°í‹°ì™€ JQPLë¡œ ì¡°íšŒí•œ ê°ì²´ê°€ ì„œë¡œ ê°™ì€ ê°ì²´ (DBì— ì—…ë°ì´íŠ¸í•œ ë‚´ìš©ì´ ì¡°íšŒëœ ì—”í‹°í‹°ì— ë°˜ì˜ë˜ì–´ ìˆì§€ ì•ŠëŠ” í˜„ìƒ ë°œìƒ)**

##### ì‹¤ì œ ë™ì‘ ì´ë¯¸ì§€
<p align="center"><img src="/images/jpa-clear-2.JPG" width="750"></p>

## 3. JPQL ì—…ë°ì´íŠ¸ í›„ ìºì‹±ëœ ë°ì´í„° ì¡°íšŒ í…ŒìŠ¤íŠ¸
ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ë©´ find ë©”ì†Œë“œë¥¼ í†µí•´ ì¡°íšŒí•œ ì—”í‹°í‹°ì™€ JPQLë¡œ ì¡°íšŒí•œ ê°ì²´ê°€ ë™ì¼í•œ ì£¼ì†Œë¥¼ ê°€ì§ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
- JPQL ì—…ë°ì´íŠ¸ ê²°ê³¼ê°€ ë°˜ì˜ë˜ì§€ ì•Šì€ ê°ì²´ê°€ ì¡°íšŒë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
package blog.in.action.clear;

import static org.junit.jupiter.api.Assertions.assertTrue;
import blog.in.action.entity.Member;
import java.util.ArrayList;
import java.util.List;
import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.PersistenceUnit;
import javax.persistence.TypedQuery;
import lombok.extern.log4j.Log4j2;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@Log4j2
@SpringBootTest
public class WrongScenarioTest {

    @PersistenceUnit
    private EntityManagerFactory factory;

    @BeforeEach
    private void beforeEach() {
        EntityManager em = factory.createEntityManager();
        try {
            em.getTransaction().begin();
            Member member = em.find(Member.class, "01012341234");
            if (member == null) {
                member = new Member();
                member.setId("01012341234");
                member.setPassword("1234");
                member.setMemberName("Junhyunny");
                member.setMemberEmail("kang3966@naver.com");
                em.persist(member);
            } else {
                member.setAuthorities(new ArrayList<>());
            }
            em.getTransaction().commit();
        } catch (Exception ex) {
            em.getTransaction().rollback();
            log.error("exception occurs", ex);
        } finally {
            em.close();
        }
    }

    @Test
    public void test() {
        EntityManager em = factory.createEntityManager();
        try {
            em.getTransaction().begin();

            Member member = em.find(Member.class, "01012341234");

            List<String> authorities = new ArrayList<>();
            authorities.add("MEMBER");
            member.setAuthorities(authorities);

            String jpql = "update Member m set m.authorities = 'JQPL_MEMBER' where m.id = '01012341234'";
            em.createQuery(jpql).executeUpdate();

            jpql = "select m from Member m where m.id = '01012341234'";
            TypedQuery<Member> query = em.createQuery(jpql, Member.class);
            Member jpqlMember = query.getSingleResult();

            assertTrue(System.identityHashCode(member) == System.identityHashCode(jpqlMember));
            log.info("member ê°ì²´ì˜ ê¶Œí•œ: " + member.getAuthorities());
            log.info("jpqlMember ê°ì²´ì˜ ê¶Œí•œ: " + jpqlMember.getAuthorities());

            em.getTransaction().commit();
        } catch (Exception ex) {
            em.getTransaction().rollback();
            log.error("exception occurs", ex);
        } finally {
            em.close();
        }
    }
}
```

##### í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¡œê·¸

```
Hibernate: select member0_.id as id1_0_0_, member0_.authorities as authorit2_0_0_, member0_.member_email as member_e3_0_0_, member0_.member_name as member_n4_0_0_, member0_.password as password5_0_0_ from tb_member member0_ where member0_.id=?
Hibernate: update tb_member set authorities=?, member_email=?, member_name=?, password=? where id=?
Hibernate: select member0_.id as id1_0_0_, member0_.authorities as authorit2_0_0_, member0_.member_email as member_e3_0_0_, member0_.member_name as member_n4_0_0_, member0_.password as password5_0_0_ from tb_member member0_ where member0_.id=?
Hibernate: update tb_member set authorities=?, member_email=?, member_name=?, password=? where id=?
Hibernate: update tb_member set authorities='JQPL_MEMBER' where id='01012341234'
Hibernate: select member0_.id as id1_0_, member0_.authorities as authorit2_0_, member0_.member_email as member_e3_0_, member0_.member_name as member_n4_0_, member0_.password as password5_0_ from tb_member member0_ where member0_.id='01012341234'
2021-08-22 02:28:57.001  INFO 16828 --- [           main] blog.in.action.clear.WrongScenarioTest   : member ê°ì²´ì˜ ê¶Œí•œ: [MEMBER]
2021-08-22 02:28:57.002  INFO 16828 --- [           main] blog.in.action.clear.WrongScenarioTest   : jpqlMember ê°ì²´ì˜ ê¶Œí•œ: [MEMBER]
```

## 4. JPQL ì—…ë°ì´íŠ¸ í›„ ë°˜ì˜ ë°ì´í„° ì¡°íšŒ í…ŒìŠ¤íŠ¸
entityManager.clear() ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìºì‹±ëœ ê°ì²´ë“¤ì„ ë¹„ì›Œì¤ë‹ˆë‹¤. 
ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- find ë©”ì†Œë“œë¥¼ í†µí•´ ì¡°íšŒí•œ ì—”í‹°í‹° ì£¼ì†Œì™€ JPQLë¡œ ì¡°íšŒí•œ ê°ì²´ì˜ ì£¼ì†Œê°€ ë‹¤ë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
- JPQL ì—…ë°ì´íŠ¸ ê²°ê³¼ê°€ ë°˜ì˜ëœ ê°ì²´ê°€ ì¡°íšŒë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
package blog.in.action.clear;

import static org.junit.jupiter.api.Assertions.assertTrue;
import blog.in.action.entity.Member;
import java.util.ArrayList;
import java.util.List;
import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.PersistenceUnit;
import javax.persistence.TypedQuery;
import lombok.extern.log4j.Log4j2;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@Log4j2
@SpringBootTest
public class JpaClearTest {

    @PersistenceUnit
    private EntityManagerFactory factory;

    @BeforeEach
    private void beforeEach() {
        EntityManager em = factory.createEntityManager();
        try {
            em.getTransaction().begin();
            Member member = em.find(Member.class, "01012341234");
            if (member == null) {
                member = new Member();
                member.setId("01012341234");
                member.setPassword("1234");
                member.setMemberName("Junhyunny");
                member.setMemberEmail("kang3966@naver.com");
                em.persist(member);
            } else {
                member.setAuthorities(new ArrayList<>());
            }
            em.getTransaction().commit();
        } catch (Exception ex) {
            em.getTransaction().rollback();
            log.error("exception occurs", ex);
        } finally {
            em.close();
        }
    }

    @Test
    public void test() {
        EntityManager em = factory.createEntityManager();
        try {
            em.getTransaction().begin();

            Member member = em.find(Member.class, "01012341234");
            List<String> authorities = new ArrayList<>();
            authorities.add("MEMBER");
            member.setAuthorities(authorities);

            em.clear();

            String jpql = "update Member m set m.authorities = 'JQPL_MEMBER' where m.id = '01012341234'";
            em.createQuery(jpql).executeUpdate();

            jpql = "select m from Member m where m.id = '01012341234'";
            TypedQuery<Member> query = em.createQuery(jpql, Member.class);
            Member jpqlMember = query.getSingleResult();

            assertTrue(System.identityHashCode(member) != System.identityHashCode(jpqlMember));
            log.info("member ê°ì²´ì˜ ê¶Œí•œ: " + member.getAuthorities());
            log.info("jpqlMember ê°ì²´ì˜ ê¶Œí•œ: " + jpqlMember.getAuthorities());

            em.getTransaction().commit();
        } catch (Exception ex) {
            em.getTransaction().rollback();
            log.error("exception occurs", ex);
        } finally {
            em.close();
        }
    }
}
```

##### í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¡œê·¸

```
Hibernate: select member0_.id as id1_0_0_, member0_.authorities as authorit2_0_0_, member0_.member_email as member_e3_0_0_, member0_.member_name as member_n4_0_0_, member0_.password as password5_0_0_ from tb_member member0_ where member0_.id=?
Hibernate: update tb_member set authorities=?, member_email=?, member_name=?, password=? where id=?
Hibernate: select member0_.id as id1_0_0_, member0_.authorities as authorit2_0_0_, member0_.member_email as member_e3_0_0_, member0_.member_name as member_n4_0_0_, member0_.password as password5_0_0_ from tb_member member0_ where member0_.id=?
Hibernate: update tb_member set authorities='JQPL_MEMBER' where id='01012341234'
Hibernate: select member0_.id as id1_0_, member0_.authorities as authorit2_0_, member0_.member_email as member_e3_0_, member0_.member_name as member_n4_0_, member0_.password as password5_0_ from tb_member member0_ where member0_.id='01012341234'
2021-08-22 02:30:22.631  INFO 8948 --- [           main] blog.in.action.clear.JpaClearTest        : member ê°ì²´ì˜ ê¶Œí•œ: [MEMBER]
2021-08-22 02:30:22.632  INFO 8948 --- [           main] blog.in.action.clear.JpaClearTest        : jpqlMember ê°ì²´ì˜ ê¶Œí•œ: [JQPL_MEMBER]
```

#### TEST CODE REPOSITORY
- <https://github.com/Junhyunny/blog-in-action/tree/master/2021-02-11-jpa-clear>

#### REFERENCE
- <https://cheese10yun.github.io/jpa-persistent-context/>

[jpa-blog-link]: https://junhyunny.github.io/spring-boot/jpa/java-persistence-api/
[jpa-persistence-context-link]: https://junhyunny.github.io/spring-boot/jpa/junit/jpa-persistence-context/
[persistence-context-advantages-link]: https://junhyunny.github.io/spring-boot/jpa/junit/persistence-context-advantages/
[jpa-flush-link]: https://junhyunny.github.io/spring-boot/jpa/junit/jpa-flush/