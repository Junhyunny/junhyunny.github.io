---
title: "Microservice Architecture"
search: false
category: 
	- main project
	- information
	- msa
last_modified_at: 2020-12-31T00:00:00
---

# Microservice Architecture

> 마이크로서비스 아키텍처의 큰 특징은 애플리케이션을 핵심 기능으로 세분화하는 방식입니다.<br>
> 각 기능을 서비스라고 부르며, 독립적으로 구축하고 배포할 수 있습니다.

입사 후 처음 참여한 프로젝트는 기존의 모놀리식 아키텍처(Monilithic Architecture) 시스템을 마이크로서비스 아키텍처(Microservice Architecture)로 재구성하는 일이었습니다. 

![microservice-architecture-1](/images/microservice-architecture-1.JPG)
<center>이미지 출처, https://www.redhat.com/ko/topics/microservices/what-are-microservices</center><br>

기본 설계 당시에는 현재 시스템을 업무 단위로 나누는 작업을 수행하였습니다. 
저는 비즈니스적으로 많은 부분을 모르기 때문에 이론상으로 어려울 것이 없어 보였지만 기존 시스템을 비즈니스 영억별로 분할할 때마다 눈에는 보이지 않던 걸림돌들이 저희 팀의 발목을 잡았습니다. 
마이크로서비스 아키텍처의 특징은 어떤 것들이 있고 이를 적용시키기 위해 어떤 어려움을 겪었는지 정리해보았습니다. 

## Microservice Architecture 특징
### 단일 목적 수행 (Single Purpose)
> **Do one thing, and do it well.**

마이크로서비스는 단일 역량을 담당합니다. 서비스 하나에 책입도 하나입니다. 이는 비즈니스와 관련될 수도 있고 제삼자와의 연계와 같은 공유 기술 역량일 수도 있습니다. 
이 특징은 마이크로서비스의 높은 응집도(High Cohesion)로 이어집니다.

### 느슨한 결합 (Loose Coupling)
마이크로서비스는 자신의 데이터 저장소가 있는 경우 데이터 저장소에 대한 오너십을 가집니다. 
**이는 서비스 결합력을 줄여주는데, 다른 서비스는 자신이 소유하지 않은 데이터에 접근할 때 데이터를 소유한 서비스가 제공한 인터페이스를 통해서만 접근이 가능합니다.**

### 높은 응집도 (High Cohesion)
마이크로서비스는 단일 비즈니스를 수행하기 때문에 서비스의 기능들은 자연스럽게 높은 응집도를 가지게 됩니다. 
각 서비스는 모든 관련된 행위와 데이터를 캡슐화하여 관리합니다. 
새로운 기능을 구축해야하는 경우 모든 변경 사항이 하나의 단일 서비스에서만 수정되도록 해야합니다. 

![microservice-architecture-2](/images/microservice-architecture-2.JPG)
<center>이미지 출처, https://medium.com/dtevangelist/microservice-at-medium-58214fd055b7</center><br>

최초 마이크로서비스를 설계할 때 도메인 전문가의 부재로 인해 기존 시스템의 모듈 단위로 비즈니스가 분할되었으며 이를 마이크로서비스들로 도출하였습니다. 
잘못된 설계로 인해 아래와 같은 문제점들을 맞닥뜨렸습니다. 

#### 업무 영역(domain context boundary)은 어떻게 나워야 하나?
DDD(Domain Driven Design)을 통해 큰 업무를 독립적인 단위로 나누는 작업을 진행했습니다. 
**이 작업은 현장 근무자 입장에서 업무적인 독립성을 기준으로 업무를 분할하여 서비스로 도출해내는 일입니다.**
기존 시스템의 모듈 단위로 서비스가 분할되면서 특정 모듈의 기능을 API 요청을 통해 제공받는 구조가 되었습니다. 
이런 설계는 단일 목적 수행의 특징은 만족하였지만 특정 서비스로의 과도한 API 요청으로 인해 전체 시스템의 성능을 떨어뜨렸습니다. 
또한 동기식 요청 방식은 서비스의 결합력을 높이는 행위이기 때문에 마이크로서비스 아키텍처의 장점을 살리지 못한 결과를 가져다 주었습니다. 

#### Transaction rollback은 어디까지 되어야 하나?
각 서비스별로 오너십을 가지는 테이블들이 생기면서 분산 환경에서의 트랜잭션 관리가 필요하게 됬습니다. 
특정 서비스에서의 트랜잭션 실패는 이전 서비스들 중 어느 서비스까지 rollback 되어야 하는지, 
서비스 별로 다수의 인스턴스들 사이에서 해당 트랜잭션을 수행한 인스턴스를 찾는 일 등의 여러가지 과제를 안겨주었습니다. 
**마이크로서비스의 설계가 잘 이루어졌다면 특정 서비스가 한 일은 다른 서비스의 업무와 독립적일테니 서비스들간의 transaction rollback에 대한 고민은 없어야 한다고 생각합니다.** 

#### 모든 비즈니스에서 동시에 사용되는 테이블은 어떻게 관리할 것인가?
각 서비스별로 테이블의 오너십을 가지지만 특정 1개의 테이블은 모든 비즈니스에서 필요한 테이블이었습니다. 
시스템 모듈 단위로 마이크로서비스를 설계하다 보니 공통으로 사용하는 테이블이 생겼으며 이를 관리하기 위한 별도의 공유 서비스를 설계하였습니다. 

#### 문제 해결
문제가 되는 서비스들을 하나씩 묶어나갔습니다. 
**트랜잭션 관리의 용이성, 비즈니스적 독립성 등을 고려하면서 서비스들을 합쳐 나갔으며 최초 48개의 서비스가 최종적으로 8개의 서비스로 통합되었습니다.** 
서비스들이 합쳐지면서 마이크로서비스라 부르기에는 다소 규모가 있는 모습이 되었습니다.

## Microservice Architecture 핵심 원칙
- 자율성 (Autonomy)
  - 각 서비스는 다른 서비스와 독립적으로 변경되고 운영됩니다.
	- 자율성을 확실히 하기 위해 느슨한 결합이 필요합니다.
	- 독립적으로 배포가 가능해야합니다.
- 회복성 (Resilience)
  - 마이크로서비스를 자연스러운 메커니즘을 통해 장애를 격리시킵니다.
	- 독립적으로 배포하면 어플리케이션 또는 인프라 장애는 시스템 일부에만 영향을 미칩니다.
	- 어플리케이션을 여러 서비스로 분리하여 장애를 격리시킬 수 있지만 장애 지점이 늘어나게 됩니다.
	- 장애가 발생할 때 확산을 막으려면 발생한 일을 처리해야합니다.
	- 가능한 부분에 비동기 처리를 하고 적절한 회로 차단기와 타임아웃을 사용하도록 설계해야 합니다.
- 투명성 (Transparency)
	- MSA는 여러 서비스가 협업하기 때문에 시스템 어느 지점에서나 투명하고 관찰 가능해야 문재를 관찰하고 진단할 수 있습니다.
	- 이를 위한 비즈니스, 운영, 인프라스트럭처 메트릭, 로그, 요청 추적 등을 생성해야합니다.
- 자동화 (Automation)
  - MSA는 단일 어플리케이션을 개발하는 것보다 복잡한 아키텍처 구조를 가집니다.
	- 자동화된 CI/CD 를 통해 배포와 운영을 안정적으로 수행해야 합니다.

## OPINION
마이크로서비스 아키텍처의 성공적인 설계를 위한 핵심은 비즈니스 도메인에 대한 전문성이라고 생각됩니다. 
비즈니스 도메인의 업무 영억을 의미있게 분할하는 일을 통해 독립적이고 자율성있는 마이크로서비스를 도출해낼 수 있습니다. 
**마이크로서비스 아키텍처가 모든 비즈니스에 적합하진 않겠지만 비즈니스 도메인에 대한 높은 이해도가 아키텍처 설계의 승패를 가른다는 것을 경험하였습니다.**

#### 참조글
- <https://12bme.tistory.com/517>
- <https://medium.com/dtevangelist/microservice-at-medium-58214fd055b7>
- <https://www.redhat.com/ko/topics/microservices/what-are-microservices>