---
title: "ThreadLocal 클래스"
search: false
category:
  - java
last_modified_at: 2023-04-18T23:55:00
---

<br/>

#### RECOMMEND POSTS BEFORE THIS

* [Proccess and Thread][process-vs-thread-link]

## 1. ThreadLocal 클래스

JDK 1.2부터 지원된 기능입니다. 
스레드(thread) 단위로 값을 저장할 수 있는 메모리 공간입니다. 
ThreadLocal 클래스에 대해 알아보기 전에 `Java` 메모리 중 스택(stack)을 간단하게 살펴보겠습니다. 

### 1.1. Stack Memory for Thread in Java

`Java`는 각 스레드에게 스택이라는 고유한 메모리 공간을 부여합니다. 
각 스레드 별로 가지는 저장 공간이며 다른 스레드들과 공유하지 않습니다. 
스레드는 자신이 만드는 실행 흐름에서 메소드를 호출할 때마다 스택에 필요한 컨텍스트(context)를 만들고 제거하기를 반복합니다. 

##### Stack Memory for Thread

* 스레드가 메소드를 실행하면 스택에 필요한 컨텍스트를 생성합니다.
* 메소드 내부에서 선언한 로컬 변수는 스택 공간을 차지합니다.
* 메소드 내부에서 생성한 객체는 힙(heap) 공간을 차지합니다.
* 로컬 변수엔 힙에 생성된 객체를 참조할 수 있도록 객체의 주소가 저장됩니다. 
* 힙에 생성된 객체는 스택의 로컬 변수를 통해서만 접근 가능하기 때문에 다른 스레드에서 접근할 수 없습니다. 

<p align="center">
    <img src="/images/thread-local-class-in-java-1.JPG" width="80%" class="image__border">
</p>

### 1.2. Inside ThreadLocal

ThreadLocal 클래스는 어떤 구조를 통해 스레드 단위에 데이터 저장이 가능한지 구조를 살펴보겠습니다. 
자주 사용되는 메소드를 기준으로 살펴보겠습니다. 

* withInitial 메소드
    * 람다식을 통해 ThreadLocal 객체의 초기 값을 지정합니다.
* get 메소드
    * ThreadLocal 객체에 저장된 값을 찾습니다.
    * 스레드를 기준으로 ThreadLocalMap 객체를 찾습니다.
    * ThreadLocalMap 객체에서 저장된 값을 찾습니다.
    * 값을 찾을 수 없다면 초기 값을 반환합니다.
* set 메소드
    * ThreadLocal 객체에 값을 저장합니다.
    * 스레드를 기준으로 ThreadLocalMap 객체를 찾습니다.
    * ThreadLocalMap 객체를 찾았다면 해당 맵에 값을 저장합니다.
    * ThreadLocalMap 객체를 찾지 못하면 새로운 맵을 생성하고 값을 저장합니다.
* remove 메소드 
    * 스레드를 기준으로 ThreadLocalMap 객체를 찾습니다.
    * ThreadLocalMap 객체를 찾았다면 해당 맵에서 값을 비웁니다. 

```java
public class ThreadLocal<T> {

    // ...

    public static <S> ThreadLocal<S> withInitial(Supplier<? extends S> supplier) {
        return new SuppliedThreadLocal(supplier);
    }

    public T get() {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = this.getMap(t);
        if (map != null) {
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                T result = e.value;
                return result;
            }
        }
        return this.setInitialValue();
    }

    public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = this.getMap(t);
        if (map != null) {
            map.set(this, value);
        } else {
            this.createMap(t, value);
        }
    }

    public void remove() {
        ThreadLocalMap m = this.getMap(Thread.currentThread());
        if (m != null) {
            m.remove(this);
        }
    }
```

ThreadLocal 클래스의 기능을 추상화하여 이미지로 표현하면 다음과 같습니다. 

<p align="center">
    <img src="/images/thread-local-class-in-java-2.JPG" width="80%" class="image__border">
</p>

### 1.3. Why do we need ThreadLocal?

ThredLocal 클래스는 이름처럼 스레드 단위로 로컬 변수를 선언한 것처럼 사용할 수 있습니다. 
실제 로컬 변수와 차이점은 다음과 같습니다. 

* 메소드 내부에서 선언하여 사용하는 것이 아니라 static 키워드를 통해 어플리케이션 전역에서 사용합니다.
* 동일한 스레드라면 어플리케이션 코드 어디에서든 값을 저장하고 사용할 수 있습니다.

ThreadLocal 클래스는 무슨 문제점을 해결하기 위해 등장했는지 알아보겠습니다. 
다음과 같은 상황을 가정하겠습니다. 

* 스프링 프레임워크 기반의 어플리케이션을 개발
* 서블릿(servlet) 필터에서 인증된 사용자 정보를 획득
* 영속성 레이어(persistence layer)에서 인증된 사용자 정보를 활용

서블릿 필터부터 영속성 레이어까진 상당히 많은 코드를 지나야합니다. 
파라미터를 통해 

## 2. Practice

## CLOSING

#### TEST CODE REPOSITORY

#### RECOMMEND NEXT POSTS

* [Java effectively final][java-effectively-final-link]

#### REFERENCE

* <https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/ThreadLocal.html>

[process-vs-thread-link]: https://junhyunny.github.io/information/operating-system/process-vs-thread/
[java-effectively-final-link]: https://junhyunny.github.io/java/java-effectively-final/