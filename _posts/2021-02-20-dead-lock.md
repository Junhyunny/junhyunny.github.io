---
title: "교착 상태(Deadlock)"
search: false
category:
  - database
  - lock
  - computer-science
last_modified_at: 2021-02-20T00:00:00
---

# 교착 상태(Deadlock)<br>

교착 상태(Deadlock)에 대한 이론적인 내용을 우선 다뤄보고자 합니다. 
시스템 최초 가동 당시에 교착 상태 때문에 많은 어려움을 겪었습니다. 
다양한 이벤트에 의해 비즈니스 로직들이 수행되었고 각자 자신들이 필요한 리소스를 점유하다보니 시스템은 자주 교착 상태에 빠지게 되었습니다. 
다행히 오라클에서 교착 상태를 감지해 exception을 던져주기는 하지만 비즈니스 로직의 retry로 인해 장애가 해소되지 않고 모든 서비스들로 전파되기도 하였습니다.

당시에 한번 걸리면 시스템 장애를 폭탄처럼 투하하는 이 **`교착 상태`**를 모르는 팀원분들이 있다는 사실을 알았을 땐 놀랐습니다. 
대학교에서 배우는 내용인데 IT 경력 10년이 넘어가는 분들이 경력 2년차 주니어 개발자인 저에게 질문 한다니요...? 
어찌됬든 눈 앞에 펼처진 시스템 장애의 원인을 해결하라는 특명을 받고 이틀을 뜬 눈으로 지새우며 현장 장애 대응, 테스트, 시스템 배포까지 했던 기억이 납니다. 
한동안 저를 괴롭혔던 교착 상태에 대한 이론적인 내용을 한번 정리해보도록 하겠습니다. 

## 교착 상태(Deadlock)이란?

> Wiki<br>
> 두 개 이상의 작업이 서로 상대방의 작업이 끝나기 만을 기다리고 있기 때문에 결과적으로 아무것도 완료되지 못하는 상태를 가리킨다. 

이런 현상이 발생하는 이유는 한정되는 자원을 여러 실행 흐름들이 나눠서 사용하기 때문입니다. 
데이터의 정합성 때문에 특정 자원을 한 프로세스가 사용하고 있다면 다른 프로세스는 기다릴 수 밖에 없습니다. 
읽기 전용으로 사용할 때는 동시에 사용이 가능하지만, 쓰기 기능이 필요하다면 선점된 자원의 해제를 기다려야합니다.

한정된 자원들을 나눠 사용하는 상태에서 두 프로세스가 서로 동일한 자원을 다른 순서로 먼저 선점하게 된다면 어떻게 될까요? 
아래 그림과 간단한 시나리오를 통해 교착 상태를 조금 더 쉽게 이해해보도록 하겠습니다. 

##### 프로세스1, 프로세스2의 교착 상태 시나리오
1. 프로세스1은 자원1을 먼저 선점합니다.
1. 프로세스2는 자원2를 먼저 선점합니다. 
1. 프로세스1은 자원2를 사용할 수 있을 때까지 대기합니다.
1. 프로세스2는 자원1을 사용할 수 있을 때까지 대기합니다.
1. 프로세스1, 프로세스2는 서로 자원을 얻기 위해 대기하면서 교착상태에 빠집니다.
1. 외부의 개입이 없다면 두 프로세스는 서로 종료되지 못합니다. 

<p align="left"><img src="/images/dead-lock-1.JPG"></p>
<center>이미지 출처, https://includestdio.tistory.com/12</center><br>

## 교착 상태를 발생시킬 수 있는 조건
교착 상태는 한 시스템 내에서 다음 네 가지 조건이 동시에 성립할 때 발생합니다. 
아래 네 가지 조건 중 하나라도 성립하지 않도록 만들면 교착 상태를 해결할 수 있습니다. 
- 상호 배제(Mutual exclusion)
    - 자원은 한번에 한 프로세스만이 사용할 수 있어야 합니다.
- 점유 대기(Hold and wait)
    - 최소한 하나의 자원을 점유하고 다른 프로세스에게 할당된 자원을 대기하는 프로세스가 존재해야합니다.
- 비선점(No preemption)
    - 다른 프로세스에 할당된 자원은 사용이 끝날 때까지 강제로 빼앗을 수 없습니다.
- 순환 대기(Circular wait)
    - 대기 중인 프로세스들이 순환 형태로 다른 프로세스가 점유한 자원의 해제를 기다리는 상태입니다.
    - 프로세스 집합 {p0, p1, .. pn}에서 p0은 p1의 자원, p1은 pn의 자원, pn은 p0의 자원을 점유하기 위해 대기합니다. 

## 교착 상태 문제 해결 방법
여러가지 해결 방법이 존재합니다. 
이들에 대해 정리해보도록 하겠습니다.

### 교착 상태 예방(prevention)
교착 상태를 발생시킬 수 있는 4개의 조건 중 하나를 해결하는 방법입니다. 
- 상호 배제(Mutual exclusion) 부정
    - 여러 개의 프로세스가 공유 자원을 사용할 수 있도록 합니다. 읽기 전용 파일에 한해서만 가능합니다.
    - 이 조건을 부정한다면 여러 실행 흐름에 의해 자원이 동시에 사용되면서 매번 다른 실행 결과를 얻게되는 문제가 발생합니다.
- 점유 대기(Hold and wait) 부정
    - 프로세스가 실행되기 전에 필요한 모든 자원을 요청하고 허용되기까지 대기합니다.
    - 자원을 효율적으로 사용하지는 못하는 시스템이 됩니다.
    - 우선 순위가 낮은 프로세스는 계속 자원을 할당받지 못하는 기아 현상(starvation)이 발생할 수 있습니다.
- 비선점(No preemption) 부정
    - 높은 우선순위의 프로세스가 다른 프로세스가 사용 중인 자원을 점유합니다.
    - 자원을 뺏긴 프로세스는 작업하던 냉용을 잃을 수 있습니다.
- 순환 대기(Circular wait) 부정
    - 자원을 순환 형태로 대기하지 않도록 일정한 방향으로만 자원을 요구할 수 있도록 합니다.
    - 어플리케이션 개발자에 의해 적절한 순서로 실행될 수 있도록ㅈ 프로그램되어야 합니다.

### 교착 상태 회피(avoidance)
교착 상태 예방은 교착 상태를 막을 수 있지만 자원을 효율적으로 사용하지는 못합니다. 
교착 상태 회피는 덜 엄격한 제약 조건을 통해 자원을 조금 더 효율적으로 사용할 수 있게 합니다. 
안전 상태(safe state), 자원 할당 그래프 알고리즘, 은행원 알고리즘 같은 교착 상태 회피 알고리즘들이 존재합니다. 

#### 안전 상태(Safe State)
시스템의 모든 프로세스들이 요청하는 모든 자원을 교착 상태를 만들지 않으면서 차례로 모두에게 할당해 줄 수 있는 상태를 의미합니다. 
**시스템이 안전 상태라는 의미는 안전 순서(safe sequence)가 존재한다는 뜻입니다.** 

그렇다면 안전 순서는 무엇인가요? 
교착 상태를 만들지 않도록 프로세스들에게 자원을 할당해주는 순서입니다. 


### 교착 상태 탐지(detection)

### 교착 상태 회복(recovery)

## OPINION
다음 글은 테스트 코드를 통해 교착 상태를 만들어보고 이를 해결해보는 코드를 작성해보도록 하겠습니다.

#### 참조글
- <https://includestdio.tistory.com/12>
- <https://chanhuiseok.github.io/posts/cs-2/>