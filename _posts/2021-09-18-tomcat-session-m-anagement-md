---
title: "Tomcat Session íšë“ê³¼ ë§Œë£Œ"
search: false
category:
  - information
  - server
last_modified_at: 2021-09-19T23:55:00
---

<br>

ğŸ‘‰ ì•„ë˜ ê¸€ì€ í•´ë‹¹ í¬ìŠ¤íŠ¸ë¥¼ ì½ëŠ”ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.
- [ì¿ í‚¤(Cookie)ì™€ ì„¸ì…˜(Session)][cookie-session-link]
- [Spring Filter, Interceptor ê·¸ë¦¬ê³  AOP][filter-interceptor-aop-link]

## 0. ë“¤ì–´ê°€ë©´ì„œ

ì´ë²ˆ ì‹œìŠ¤í…œ ë¦¬ë‰´ì–¼ ì¤‘ì¸ í”„ë¡œì íŠ¸ì˜ ì½”ë“œë¥¼ ë³´ë©´ ë§ì€ ì‚¬ìš©ì ì •ë³´ê°€ ì„¸ì…˜ì— ë‹´ê²¨ ì‚¬ìš©ë˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. 
íŠ¹íˆ ë¡œê·¸ì¸ ì„±ê³µì‹œ ë§ì€ ë°ì´í„°ê°€ ì„¸ì…˜ì— ì¶”ê°€ë˜ëŠ”ë°, ëª¨ë°”ì¼ ë¡œê·¸ì¸ ê¸°ëŠ¥ ì¶”ê°€ë¥¼ ìœ„í•´ ì„¸ì…˜ ë™ì‘ì„ ì •í™•íˆ ì´í•´í•  í•„ìš”ê°€ ìˆì„ ê²ƒ ê°™ì•„ì„œ ì •ë¦¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤. 
`Tomcat` ì„œë²„ì™€ `JSP` ê¸°ìˆ  ìŠ¤íƒì„ ê¸°ì¤€ìœ¼ë¡œ ë¶„ì„í•˜ì˜€ìŠµë‹ˆë‹¤. 
í•´ë‹¹ ê¸°ìˆ  ìŠ¤íƒì„ ì‚¬ìš©í•  ë•Œ ë™ì‘í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì •ë¦¬í•œ ê²ƒì´ë¯€ë¡œ ê¸€ì„ ì½ì–´ë³´ì‹œëŠ” ë¶„ë“¤ì€ ì£¼ì˜í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.

## 1. ì„¸ì…˜(Session) ìƒì„±

### 1.1. ì„¸ì…˜ ìƒì„± ë° ì¿ í‚¤(Cookie) ì„¸íŒ…
ì²˜ìŒ ì„œë²„ì— ì ‘ê·¼í•˜ëŠ” ì‹œì ì—” ì¿ í‚¤ì— ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. 
ì¿ í‚¤ ì •ë³´ëŠ” ì‘ë‹µ í—¤ë”ë¥¼ í†µí•´ ì„œë²„ë¡œë¶€í„° ì „ë‹¬ë°›ìŠµë‹ˆë‹¤. 
ì„œë²„ë¡œë¶€í„° í•œë²ˆ ì‘ë‹µì„ ë°›ì€ ì‹œì ì— ì¿ í‚¤ê°€ ìƒì„±ë˜ë©°, ì´í›„ë¶€í„°ëŠ” ë¸Œë¼ìš°ì €ê°€ ì¿ í‚¤ ì •ë³´ë¥¼ ìŠ¤ìŠ¤ë¡œ ìš”ì²­ í—¤ë”(request header)ì— ì¶”ê°€í•˜ì—¬ ë°ì´í„°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤. 

##### ì²« ìš”ì²­ ì •ë³´ì™€ ê·¸ ì´í›„ ìš”ì²­ ì •ë³´ì˜ ì°¨ì´ì 

<p align="center"><img src="/images/tomcat-session-management-1.JPG" width="80%"></p>

### 1.2. ì„¸ì…˜ ìƒì„±ê³¼ ì¿ í‚¤ ìƒì„± ì‹œì 
ì²˜ìŒ ìš”ì²­ ì‹œì—ëŠ” ì—†ì—ˆë˜ ì¿ í‚¤ ì •ë³´ê°€ ì–´ëŠ ì‹œì ì— ìƒì„±ë˜ëŠ”ì§€ ì½”ë“œë¥¼ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. 
í”„ë¡œì„¸ìŠ¤ ìˆœì„œë¥¼ í¬ê²Œ ë‚˜ëˆ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
1. ì»¨íŠ¸ë¡¤ëŸ¬(controller)ì—ì„œ ì‘ë‹µ í˜ì´ì§€ ë°˜í™˜í•©ë‹ˆë‹¤.
1. `DispatcherServlet`ì—ì„œ ì „ë‹¬ë°›ì€ í˜ì´ì§€ë¥¼ `JstlViewer` ê°ì²´ë¥¼ ì´ìš©í•˜ì—¬ ë Œë”ë§(rendering)í•©ë‹ˆë‹¤. 
1. ë Œë”ë§ ìˆ˜í–‰ ì¤‘ `JspServlet` ê°ì²´ì— ì˜í•´ PageContext ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ëŠ” ì‹œì ì— ì„¸ì…˜ì´ ìƒì„±ë©ë‹ˆë‹¤.
1. ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ì„¸ì…˜ID ì •ë³´ë¥¼ ì‘ë‹µ í—¤ë”ì— ì¿ í‚¤ë¡œ ë‹´ì•„ì„œ ì „ë‹¬í•©ë‹ˆë‹¤.

<p align="center"><img src="/images/tomcat-session-management-2.JPG" width="75%"></p>

### 1.3. ì£¼ìš” í´ë˜ìŠ¤ì™€ ë©”ì†Œë“œ

#### 1.3.1. org.apache.catalina.connector.Request í´ë˜ìŠ¤ doGetSession ë©”ì†Œë“œ
ì‹¤ì œë¡œ ì„¸ì…˜ì´ ìƒì„±ë˜ëŠ” í–‰ìœ„ëŠ” org.apache.catalina.connector íŒ¨í‚¤ì§€ì— Request í´ë˜ìŠ¤ì—ì„œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. 
ìŠ¤í”„ë§ ì˜ì—­ì´ ì•„ë‹Œ í†°ìº£ ì˜ì—­ì—ì„œ ì´ëŸ° í–‰ìœ„ê°€ ì¼ì–´ë‚œë‹¤ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤. 

- ì•„íŒŒì¹˜(apache) ì¹´íƒˆë¦¬ë‚˜(catalina) íŒ¨í‚¤ì§€ì— ìœ„ì¹˜í•œ Request í´ë˜ìŠ¤ì—ì„œ ìƒì„±ë©ë‹ˆë‹¤. 
- createSession ë©”ì†Œë“œì—ì„œ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ì„¸ì…˜IDë¥¼ ë§Œë“¤ê³  ì„¸ì…˜ ê°ì²´ë¥¼ ë§Œë“¤ì–´ ë°˜í™˜í•©ë‹ˆë‹¤.
- ì„¸ì…˜ì´ ìƒì„±ë˜ê³  íŠ¸ë™í‚¹ ëª¨ë“œ(tracking mode)ì— ì¿ í‚¤ê°€ í¬í•¨ëœë‹¤ë©´ ì„¸ì…˜ ì •ë³´ë¥¼ ì¿ í‚¤ì— ë‹´ê³  ì‘ë‹µ ì •ë³´ì— ì €ì¥í•©ë‹ˆë‹¤.

```java
package org.apache.catalina.connector;

public class Request implements HttpServletRequest {

    // ...

    protected Session doGetSession(boolean create) {

        // ...

        // ì„¸ì…˜ ìƒì„± ë° ì„¸ì…˜ID ìƒì„±
        session = manager.createSession(sessionId);

        // Creating a new session cookie based on that session
        if (session != null && trackModesIncludesCookie) {
            Cookie cookie = ApplicationSessionCookieConfig.createSessionCookie(
                    context, session.getIdInternal(), isSecure());

            // ì‘ë‹µì— ì„¸ì…˜ ì •ë³´ê°€ ë‹´ê¸´ ì¿ í‚¤ ì •ë³´ ì¶”ê°€
            response.addSessionCookieInternal(cookie);
        }
    }
}
```

#### 1.3.2. org.apache.catalina.connector.Response í´ë˜ìŠ¤ addSessionCookieInternal ë©”ì†Œë“œ
ì‘ë‹µ í—¤ë”ì— ì¿ í‚¤ ì •ë³´ë¥¼ ë‹´ëŠ” ì½”ë“œëŠ” org.apache.catalina.connector íŒ¨í‚¤ì§€ì— Response í´ë˜ìŠ¤ì— ìœ„ì¹˜í•©ë‹ˆë‹¤. 

```java
package org.apache.catalina.connector;

public class Response implements HttpServletResponse {

    // ...

    public void addSessionCookieInternal(final Cookie cookie) {
        if (isCommitted()) {
            return;
        }
        String name = cookie.getName();
        final String headername = "Set-Cookie";
        final String startsWith = name + "=";
        String header = generateCookieString(cookie);
        boolean set = false;
        MimeHeaders headers = getCoyoteResponse().getMimeHeaders();
        int n = headers.size();
        for (int i = 0; i < n; i++) {
            if (headers.getName(i).toString().equals(headername)) {
                if (headers.getValue(i).toString().startsWith(startsWith)) {
                    headers.getValue(i).setString(header);
                    set = true;
                }
            }
        }
        if (!set) {
            addHeader(headername, header);
        }
    }
}
```

### 2. ì„¸ì…˜(Session) íšë“

#### 2.1. ì¿ í‚¤(Cookie)ë¥¼ í™œìš©í•œ ì„¸ì…˜ID íšë“
ì²« ìš”ì²­ì‹œ ë§Œë“¤ì–´ì§„ ì„¸ì…˜IDì™€ ì„¸ì…˜ì„ ì–´ë–»ê²Œ íšë“í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì•˜ìŠµë‹ˆë‹¤. 
ì„¸ì…˜IDë¥¼ íšë“í•˜ë©´ ì–´ë””ì—ì„œë“  ì„¸ì…˜ ì •ë³´ë¥¼ êº¼ë‚¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì„¸ì…˜IDë¥¼ ì¶”ì¶œí•˜ëŠ” ì‹œì ë§Œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤. 
ì„¸ì…˜IDëŠ” ìš”ì²­ì„ ë°›ì€ ì‹œì ì— ì¿ í‚¤ì—ì„œ ì¶”ì¶œí•©ë‹ˆë‹¤. 
1. CoyoteAdapter í´ë˜ìŠ¤ì˜ postParseRequest ë©”ì†Œë“œì—ì„œ ì„¸ì…˜IDë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. 
1. ì„¸ì…˜ ì¶”ì (tracking)ì„ URLì„ í†µí•´ ìˆ˜í–‰í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
1. URLì—ì„œ ì¶”ì¶œí•  ìˆ˜ ìˆë‹¤ë©´ URL ìš”ì²­ ì •ë³´ì—ì„œ ì„¸ì…˜IDë¥¼ íšë“í•©ë‹ˆë‹¤.
1. ìš”ì²­ URLì—ì„œ ì¶”ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ parseSessionCookiesId ë©”ì†Œë“œë¥¼ í†µí•´ ì¿ í‚¤ì—ì„œ ì„¸ì…˜IDë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. 

<p align="center"><img src="/images/tomcat-session-management-3.JPG" width="75%"></p>

### 2.2. í•„í„° ì˜ì—­ì—ì„œ ì„¸ì…˜ íšë“

### 2.3. ì¸í„°ì…‰í„° ì˜ì—­ì—ì„œ ì„¸ì…˜ íšë“

### 2.4. ì–´í”Œë¦¬ì¼€ì´ì…˜ ì˜ì—­ì—ì„œ ì„¸ì…˜ íšë“

## 2. Session ë§Œë£Œ
íšë“í•˜ëŠ” ê³¼ì •ì„ ëª¨ë‘ ì‚´í´ë³´ì•˜ëŠ”ë° 

### 2.1. ì„¸ì…˜ ë§Œë£Œ ì²˜ë¦¬ ìœ„ì¹˜

### 2.1. Tomcat Server ì„¸ì…˜ ë§Œë£Œ ì„¤ì •

### 2.2. Embedded Tomcat ì„¸ì…˜ ë§Œë£Œ ì„¤ì •

## 3. Rest API ì‚¬ìš©ì‹œ ì„¸ì…˜ ë¯¸ìƒì„±

#### REFERENCE

[cookie-session-link]: https://junhyunny.github.io/information/cookie-and-session/
[filter-interceptor-aop-link]: https://junhyunny.github.io/spring-boot/filter-interceptor-and-aop/