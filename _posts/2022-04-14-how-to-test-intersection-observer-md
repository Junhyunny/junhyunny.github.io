---
title: "How to test Intersection Observer"
search: false
category:
  - javascript
  - jest
  - testing-library
  - test-driven-development
last_modified_at: 2022-04-14T23:55:00
---

<br>

ğŸ‘‰ í•´ë‹¹ í¬ìŠ¤íŠ¸ë¥¼ ì½ëŠ”ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.
- [Asynchronous Task In JavaScript][how-to-work-javascript-async-link]

## 0. ë“¤ì–´ê°€ë©´ì„œ

ë¬´í•œ ìŠ¤í¬ë¡¤(infinite scroll) ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ì„œ ë§Œë‚œ ì—ëŸ¬ì™€ í•´ê²°í•˜ëŠ” ê³¼ì •ì„ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤. 

## 1. Intersection Observer API

`Intersection Observer`ëŠ” íƒ€ê²Ÿ ì—˜ë¦¬ë¨¼íŠ¸(target element)ê°€ ê´€ì°°í•˜ê³  ìˆëŠ” í™”ë©´ì— ë³´ì—¬ì§€ëŠ”ì§€ í™•ì¸í•˜ëŠ” Web API ê¸°ëŠ¥ì…ë‹ˆë‹¤. 
ì´ë²ˆ í¬ìŠ¤íŠ¸ëŠ” `Intersection Observer`ë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì„ ì •ë¦¬í•˜ì˜€ê¸° ë•Œë¬¸ì— ê°„ë‹¨í•œ ì„¤ëª…ê³¼ ìš©ì–´ë§Œ ì •ë¦¬í•˜ê³  ê¸€ì„ ì´ì–´ë‚˜ê°€ê² ìŠµë‹ˆë‹¤. 

ì•„ë˜ ìš©ì–´ë“¤ê³¼ ê¸°ëŠ¥ì— ì´í•´ê°€ í•„ìš”í•©ë‹ˆë‹¤. 
- ë·° í¬íŠ¸(View Port)ëŠ” ê´€ì°°í•˜ê³  ìˆëŠ” ì˜ì—­ì…ë‹ˆë‹¤. 
- íƒ€ê²Ÿ ì—˜ë¦¬ë¨¼íŠ¸(Target Element)ëŠ” ê´€ì‹¬ ëŒ€ìƒì…ë‹ˆë‹¤.
- `Intersection Observer`ëŠ” íƒ€ê²Ÿ ì—˜ë¦¬ë¨¼íŠ¸ì™€ ë·° í¬íŠ¸ ì‚¬ì´ì˜ êµì°¨(cross)ë¥¼ ê´€ì°°í•©ë‹ˆë‹¤.
- `Web API` ê¸°ëŠ¥ì´ë¯€ë¡œ ë©”ì¸ ìŠ¤ë ˆë“œì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  ë¹„ë™ê¸°ì ì¸ ì½œë°± í•¨ìˆ˜ í˜¸ì¶œë¡œ ê´€ì°°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<p align="center">
    <img src="/images/how-to-test-intersection-observer-1.JPG" width="75%" class="image__border">
</p>
<center>https://cross-code.github.io/posts/IntersectionObserver/</center><br>

## 2. ì½”ë“œ ì‚´í´ë³´ê¸°

ì´í•´ë¥¼ ë•ê¸° ìœ„í•´ êµ¬í˜„ ì½”ë“œ, í…ŒìŠ¤íŠ¸ ì½”ë“œ ìˆœì„œë¡œ ê¸°ëŠ¥ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. 
ë°œìƒí•œ ì—ëŸ¬ë¥¼ í™•ì¸í•˜ê³ , ì´ë¥¼ ë³´ì™„í•˜ê¸° ìœ„í•œ ë°©ë²•ì„ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.

### 2.1. êµ¬í˜„ ì½”ë“œ
- 

```jsx
import { useCallback, useEffect, useState } from 'react'
import classes from './InfiniteScroll.module.css'
import axios from 'axios'

let intersectionObserver
let offset = 0

export default () => {
    const [pokemons, setPokemons] = useState([])

    const fetchesData = useCallback(async () => {
        const { data } = await axios.get(`https://pokeapi.co/api/v2/pokemon/?offset=${offset}&limit=20`)
        const results = data.results
        if (results.length) {
            results[results.length - 1].isLastItem = true
        }
        offset++
        setPokemons((prevState) => {
            if (prevState.length) {
                prevState[prevState.length - 1].isLastItem = false
            }
            return [].concat(prevState).concat(results)
        })
    }, [])

    useEffect(async () => {
        await fetchesData()
    }, [])

    useEffect(() => {
        intersectionObserver = new IntersectionObserver(
            (entries, observer) => {
                entries.forEach(async (entry) => {
                    if (!entry.isIntersecting) {
                        return
                    }
                    observer.unobserve(entry.target)
                    await fetchesData()
                })
            },
            {
                root: document.querySelector('#region'),
            }
        )
        return () => {
            intersectionObserver.disconnect()
        }
    }, [])

    useEffect(() => {
        const lastItem = document.querySelector('.last-pokemon')
        if (lastItem) {
            intersectionObserver.observe(lastItem)
        }
    }, [pokemons])

    return (
        <div id={'region'} className={classes.region}>
            {pokemons.map((pokemon, index) => (
                <div key={index} className={`${classes.box} ${pokemon.isLastItem ? 'last-pokemon' : ''}`}>
                    {pokemon.name}
                </div>
            ))}
        </div>
    )
}
```

### 2.2. í…ŒìŠ¤íŠ¸ ì½”ë“œ

```jsx
import {fireEvent, render, screen, waitFor} from '@testing-library/react'

import axios from 'axios'

import App from '../App'

describe('Intersection Observer', () => {
    it('when scroll down then fetch data', async () => {
        const spyAxios = jest.spyOn(axios, 'get').mockResolvedValueOnce({
            data: {
                results: [
                    { name: '1' },
                    { name: '2' },
                    { name: '3' },
                    { name: '4' },
                    { name: '5' },
                    { name: '6' },
                    { name: '7' },
                    { name: '8' },
                    { name: '9' },
                    { name: '10' },
                ],
            },
        })
        jest.spyOn(axios, 'get').mockResolvedValueOnce({
            data: {
                results: [{ name: '11' }, { name: '12' }],
            },
        })
        await waitFor(() => {
            return render(<App />)
        })

        fireEvent.scroll(document.querySelector('#region'), { y: '500px' })

        expect(await screen.findByText('11')).toBeInTheDocument()
        expect(spyAxios).toHaveBeenCalledTimes(2)
        expect(spyAxios).toHaveBeenNthCalledWith(2, 'https://pokeapi.co/api/v2/pokemon/?offset=1&limit=20')
    })
})
```

##### ì—ëŸ¬ ë°œìƒê³¼ ì›ì¸

```
IntersectionObserver is not defined
ReferenceError: IntersectionObserver is not defined
    at /Users/junhyunk/Desktop/workspace/blog-in-action/2022-04-13-how-to-test-intersection-observer/intersection-observer-test/src/intersection-observer/InfiniteScroll.js:31:9
    at invokePassiveEffectCreate (/Users/junhyunk/Desktop/workspace/blog-in-action/2022-04-13-how-to-test-intersection-observer/intersection-observer-test/node_modules/react-dom/cjs/react-dom.development.js:23487:20)
    at HTMLUnknownElement.callCallback (/Users/junhyunk/Desktop/workspace/blog-in-action/2022-04-13-how-to-test-intersection-observer/intersection-observer-test/node_modules/react-dom/cjs/react-dom.development.js:3945:14)
    at HTMLUnknownElement.callTheUserObjectsOperation (/Users/junhyunk/Desktop/workspace/blog-in-action/2022-04-13-how-to-test-intersection-observer/intersection-observer-test/node_modules/jsdom/lib/jsdom/living/generated/EventListener.js:26:30)
    ...
```

### 2.3. í…ŒìŠ¤íŠ¸ ì½”ë“œ ë³´ì™„í•˜ê¸°

#### 2.3.1 Mock IntersectionObserver êµ¬í˜„

```jsx
const mockIntersectionObserver = class {
    constructor(callback, options) {
        this.viewPort = options.root ? options.root : window
        this.observable = []
        this.viewPort.addEventListener('scroll', () => {
            this.observable.map((ob) => {
                ob.isIntersecting = this.isInViewPort(ob.target)
            })
            callback(this.observable, this)
        })
    }

    isInViewPort(target) {
        const rect = target.getBoundingClientRect()
        const viewPortRect = this.viewPort.getBoundingClientRect()
        return (
            rect.left >= viewPortRect.x &&
            rect.top >= viewPortRect.y &&
            rect.right <= viewPortRect.right &&
            rect.bottom <= viewPortRect.bottom
        )
    }

    observe(target) {
        this.observable.push({ isIntersecting: false, target })
    }

    unobserve(target) {
        this.observable = this.observable.map((ob) => ob.target !== target)
    }

    disconnect() {
        this.observable = []
    }
}
```

#### 2.3.2. ì „ì²´ ì½”ë“œ

```jsx
import { fireEvent, render, screen, waitFor } from '@testing-library/react'

import axios from 'axios'

import App from '../App'

const mockIntersectionObserver = class {
    constructor(callback, options) {
        this.viewPort = options.root ? options.root : window
        this.observable = []
        this.viewPort.addEventListener('scroll', () => {
            this.observable.map((ob) => {
                ob.isIntersecting = this.isInViewPort(ob.target)
            })
            callback(this.observable, this)
        })
    }

    isInViewPort(target) {
        const rect = target.getBoundingClientRect()
        const viewPortRect = this.viewPort.getBoundingClientRect()
        return (
            rect.left >= viewPortRect.x &&
            rect.top >= viewPortRect.y &&
            rect.right <= viewPortRect.right &&
            rect.bottom <= viewPortRect.bottom
        )
    }

    observe(target) {
        this.observable.push({ isIntersecting: false, target })
    }

    unobserve(target) {
        this.observable = this.observable.map((ob) => ob.target !== target)
    }

    disconnect() {
        this.observable = []
    }
}

window.IntersectionObserver = mockIntersectionObserver

describe('Intersection Observer', () => {
    it('when scroll down then fetch data', async () => {
        const spyAxios = jest.spyOn(axios, 'get').mockResolvedValueOnce({
            data: {
                results: [
                    { name: '1' },
                    { name: '2' },
                    { name: '3' },
                    { name: '4' },
                    { name: '5' },
                    { name: '6' },
                    { name: '7' },
                    { name: '8' },
                    { name: '9' },
                    { name: '10' },
                ],
            },
        })
        jest.spyOn(axios, 'get').mockResolvedValueOnce({
            data: {
                results: [{ name: '11' }, { name: '12' }],
            },
        })
        await waitFor(() => {
            return render(<App />)
        })

        fireEvent.scroll(document.querySelector('#region'), { y: '500px' })

        expect(await screen.findByText('11')).toBeInTheDocument()
        expect(spyAxios).toHaveBeenCalledTimes(2)
        expect(spyAxios).toHaveBeenNthCalledWith(2, 'https://pokeapi.co/api/v2/pokemon/?offset=1&limit=20')
    })
})
```

##### í…ŒìŠ¤íŠ¸ ì„±ê³µ

<p align="left">
    <img src="/images/how-to-test-intersection-observer-2.JPG" width="45%" class="image__border">
</p>

##### êµ¬í˜„ í™”ë©´

<p align="left">
    <img src="/images/how-to-test-intersection-observer-3.gif" width="45%" class="image__border">
</p>

## CLOSING



#### TEST CODE REPOSITORY
- <https://github.com/Junhyunny/blog-in-action/tree/master/2022-04-13-how-to-test-intersection-observer>

#### REFERENCE
- <https://developer.mozilla.org/ko/docs/Web/API/Intersection_Observer_API>
- <https://heropy.blog/2019/10/27/intersection-observer/>
- <https://cross-code.github.io/posts/IntersectionObserver/>

[how-to-work-javascript-async-link]: https://junhyunny.github.io/information/javascript/how-to-work-javascript-async/