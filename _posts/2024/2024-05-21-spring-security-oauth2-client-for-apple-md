---
title: "Spring Security Oauth2 Client for Apple"
search: false
category:
  - spring-boot
  - spring-security
last_modified_at: 2024-05-21T23:55:00
---

<br/>

#### RECOMMEND POSTS BEFORE THIS

- [Multiple SNS Login with Spring Security OAuth2 Client][multiple-sns-login-with-spring-security-oauth2-client-link]

## 0. 들어가면서

외부 팀에서 애플(Apple) OAuth2 로그인이 잘 동작되지 않는다고 문의가 들어 왔다. 아무래도 필자가 스프링 시큐리티(spring security)로 책을 집필 중이기도 하고 구현 경험이 꽤 많기 때문에 도움 요청이 온 것 같다. 이번엔 애플 OAuth2 인증에 필요한 추가적인 작업에 관련된 내용을 글로 정리했다. 

## 1. Problem Context

문제 현상을 살펴보자. 웹 환경에서 OAuth2 인증은 리다이렉트(redirect)의 연속이다. 애플 로그인 화면에서 인증 성공 후 애플 인가 서버에서 개발 서버로 브라우저를 다시 리다이렉트 시키는 시점에 문제가 발생한다. 문제가 발생하는 이 두번째 리다이렉트 시점에 다음과 같은 정보들이 전달되고 결국엔 에러 응답을 받는다.

- POST 메소드 요청을 보낸다.
- 컨텐츠 타입(content type)은 `application/x-www-form-urlencoded`이다.
- 요청 메세지에는 다음과 같은 정보가 담겨 있다.
  - state 
    - 상태 코드로 별도로 사용되지 않는다.
  - code 
    - 인가 코드로 액세스 토큰 혹은 ID 토큰을 받을 때 사용한다.
  - user 
    - 사용자 정보로 이름, 성, 이메일 정보 등이 들어 있다.
- 리다이렉트 된 요청은 403(forbidden) 응답을 받는다.

<div align="center">
  <img src="/images/posts/2024/spring-security-oauth2-client-for-apple-01.png" width="100%" class="image__border">
</div>

### 1.1. Phenomenon

스프링 시큐리티 내부에서 발생하는 에러에 대한 로그가 빈약하기 때문에 원인을 찾기 힘들다. 실제 로컬 환경에서 디버깅이 필요한데, 애플은 보안상의 이유로 OAuth2 로그인 인증을 위한 콜백(callback) URL(혹은 리다이렉트 URL)로 `로컬 호스트(localhost)`는 지원하지 않는다. 덕분에 로컬 환경에서 테스트가 힘들지만, 방법이 없지는 않다. 디버깅하는 방법은 잠시 뒤에 소개하겠다.

로컬 호스트에서 디버깅을 해보면 인증 제공자(AuthenticationProvider) 인스턴스가 애플 인가 서버에서 액세스 토큰(혹은 openid)를 받을 때 다음과 같은 에러가 발생하고 있었다.

```
[invalid_client]
```

<div align="center">
  <img src="/images/posts/2024/spring-security-oauth2-client-for-apple-02.png" width="80%" class="image__border">
</div>

### 1.2. What is the problem?

문제가 무엇일까? 몇 개의 예제 코드와 



### 1.3. How to debug in local environment?

위에서 언급했듯이 애플 OAuth2 로그인은 로컬 환경에서 디버깅하는 것이 힘들다. 이 글을 읽는 독자가 

로컬 호스트 환경에서 디버깅하는 방법은 잠시 뒤에 소개하도록 하겠다. 



## 2. Solve the problem

### 2.1. Extra information

### 2.2. Extend RequestEntityConverter

### 2.3. Apple's Secret Key Generator

### 2.4. Register Spring Beans

## CLOSING

#### TEST CODE REPOSITORY

#### RECOMMEND NEXT POSTS

#### REFERENCE









- <https://github.com/patrickbussmann/oauth2-apple>
- <https://stackoverflow.com/questions/64761364/cant-find-io-jsonwebtoken-impl-defaultjwtbuilder-when-starting-project-in-a-doc>
- <https://gist.github.com/patrickbussmann/877008231ef082cc5dc4ee5ca661a641>
- <https://developer.apple.com/documentation/sign_in_with_apple/fetch_apple_s_public_key_for_verifying_token_signature>
- <https://developer.apple.com/documentation/sign_in_with_apple/revoke_tokens>
- <https://developer.apple.com/documentation/accountorganizationaldatasharing/creating-a-client-secret>
- <https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens>
- <https://github.com/SWM-YouQuiz/Authentication-Service/blob/dev/build.gradle.kts>
- <https://github.com/SWM-YouQuiz/Authentication-Service/blob/847932c2047e8111a289f43e018550f5c6aef22d/src/main/kotlin/com/quizit/authentication/global/oauth/AppleOAuth2Provider.kt>


[multiple-sns-login-with-spring-security-oauth2-client-link]: https://junhyunny.github.io/java/design-pattern/spring-boot/multiple-sns-login-with-spring-security-oauth2-client/